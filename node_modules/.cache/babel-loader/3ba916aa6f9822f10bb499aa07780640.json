{"ast":null,"code":"import _regeneratorRuntime from \"C:/Users/Kompa/Desktop/games/my-app/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"C:/Users/Kompa/Desktop/games/my-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _classCallCheck from \"C:/Users/Kompa/Desktop/games/my-app/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"C:/Users/Kompa/Desktop/games/my-app/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport _classPrivateFieldInitSpec from \"C:/Users/Kompa/Desktop/games/my-app/node_modules/@babel/runtime/helpers/esm/classPrivateFieldInitSpec.js\";\nimport _defineProperty from \"C:/Users/Kompa/Desktop/games/my-app/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\nimport _classPrivateFieldGet from \"C:/Users/Kompa/Desktop/games/my-app/node_modules/@babel/runtime/helpers/esm/classPrivateFieldGet.js\";\nimport _classPrivateFieldSet from \"C:/Users/Kompa/Desktop/games/my-app/node_modules/@babel/runtime/helpers/esm/classPrivateFieldSet.js\";\nimport { runInContext as _runInContext } from \"../utils/asyncHookContext.js\";\nimport { ContextLogger } from \"./ContextLogger.js\";\nimport { LocalsContainer } from \"./LocalsContainer.js\";\nvar _container = /*#__PURE__*/new WeakMap();\nvar _cache = /*#__PURE__*/new WeakMap();\nvar _logger = /*#__PURE__*/new WeakMap();\nexport var DIContext = /*#__PURE__*/function () {\n  function DIContext(opts) {\n    _classCallCheck(this, DIContext);\n    _defineProperty(this, \"opts\", void 0);\n    _classPrivateFieldInitSpec(this, _container, {\n      writable: true,\n      value: void 0\n    });\n    _classPrivateFieldInitSpec(this, _cache, {\n      writable: true,\n      value: void 0\n    });\n    _classPrivateFieldInitSpec(this, _logger, {\n      writable: true,\n      value: void 0\n    });\n    this.opts = opts;\n  }\n  /**\n   * Logger attached to the context request.\n   */\n  _createClass(DIContext, [{\n    key: \"logger\",\n    get: function get() {\n      _classPrivateFieldSet(this, _logger, _classPrivateFieldGet(this, _logger) || new ContextLogger(this.opts));\n      return _classPrivateFieldGet(this, _logger);\n    }\n    /**\n     * Request id generated by @@contextMiddleware@@.\n     *\n     * ::: tip\n     * By default Ts.ED generate uuid like that `uuidv4().replace(/-/gi, \"\"))`.\n     * Dash are removed to simplify tracking logs in Kibana\n     * :::\n     *\n     * ::: tip\n     * Request id can by customized by changing the server configuration.\n     *\n     * ```typescript\n     * @Configuration({\n     *   logger: {\n     *     reqIdBuilder: createUniqId // give your own id generator function\n     *   }\n     * })\n     * class Server {\n     *\n     * }\n     * ```\n     * :::\n     *\n     */\n  }, {\n    key: \"id\",\n    get: function get() {\n      return this.opts.id;\n    }\n  }, {\n    key: \"dateStart\",\n    get: function get() {\n      return this.logger.dateStart;\n    }\n  }, {\n    key: \"injector\",\n    get: function get() {\n      return this.opts.injector;\n    }\n  }, {\n    key: \"env\",\n    get: function get() {\n      return this.injector.settings.get(\"env\");\n    }\n    /**\n     * The request container used by the Ts.ED DI. It contains all services annotated with `@Scope(ProviderScope.REQUEST)`\n     */\n  }, {\n    key: \"container\",\n    get: function get() {\n      return _classPrivateFieldSet(this, _container, _classPrivateFieldGet(this, _container) || new LocalsContainer());\n    }\n  }, {\n    key: \"destroy\",\n    value: function () {\n      var _destroy = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n        var _classPrivateFieldGet2, _classPrivateFieldGet3;\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              return _context.abrupt(\"return\", Promise.all([(_classPrivateFieldGet2 = _classPrivateFieldGet(this, _container)) === null || _classPrivateFieldGet2 === void 0 ? void 0 : _classPrivateFieldGet2.destroy(), (_classPrivateFieldGet3 = _classPrivateFieldGet(this, _logger)) === null || _classPrivateFieldGet3 === void 0 ? void 0 : _classPrivateFieldGet3.flush()]));\n            case 1:\n            case \"end\":\n              return _context.stop();\n          }\n        }, _callee, this);\n      }));\n      function destroy() {\n        return _destroy.apply(this, arguments);\n      }\n      return destroy;\n    }()\n  }, {\n    key: \"emit\",\n    value: function () {\n      var _emit = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee2(eventName) {\n        var _this$injector;\n        var _len,\n          args,\n          _key,\n          _args2 = arguments;\n        return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n          while (1) switch (_context2.prev = _context2.next) {\n            case 0:\n              for (_len = _args2.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n                args[_key - 1] = _args2[_key];\n              }\n              return _context2.abrupt(\"return\", (_this$injector = this.injector) === null || _this$injector === void 0 ? void 0 : _this$injector.emit.apply(_this$injector, [eventName].concat(args)));\n            case 2:\n            case \"end\":\n              return _context2.stop();\n          }\n        }, _callee2, this);\n      }));\n      function emit(_x) {\n        return _emit.apply(this, arguments);\n      }\n      return emit;\n    }()\n  }, {\n    key: \"runInContext\",\n    value: function () {\n      var _runInContext2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee3(next) {\n        return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n          while (1) switch (_context3.prev = _context3.next) {\n            case 0:\n              return _context3.abrupt(\"return\", _runInContext(this, next));\n            case 1:\n            case \"end\":\n              return _context3.stop();\n          }\n        }, _callee3, this);\n      }));\n      function runInContext(_x2) {\n        return _runInContext2.apply(this, arguments);\n      }\n      return runInContext;\n    }()\n  }, {\n    key: \"cache\",\n    value: function cache(key, cb) {\n      if (!this.has(key)) {\n        this.set(key, cb());\n      }\n      return this.get(key);\n    }\n  }, {\n    key: \"cacheAsync\",\n    value: function () {\n      var _cacheAsync = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee4(key, cb) {\n        return _regeneratorRuntime().wrap(function _callee4$(_context4) {\n          while (1) switch (_context4.prev = _context4.next) {\n            case 0:\n              if (this.has(key)) {\n                _context4.next = 7;\n                break;\n              }\n              _context4.t0 = this;\n              _context4.t1 = key;\n              _context4.next = 5;\n              return cb();\n            case 5:\n              _context4.t2 = _context4.sent;\n              _context4.t0.set.call(_context4.t0, _context4.t1, _context4.t2);\n            case 7:\n              return _context4.abrupt(\"return\", this.get(key));\n            case 8:\n            case \"end\":\n              return _context4.stop();\n          }\n        }, _callee4, this);\n      }));\n      function cacheAsync(_x3, _x4) {\n        return _cacheAsync.apply(this, arguments);\n      }\n      return cacheAsync;\n    }()\n  }, {\n    key: \"delete\",\n    value: function _delete(key) {\n      var _classPrivateFieldGet4;\n      return !!((_classPrivateFieldGet4 = _classPrivateFieldGet(this, _cache)) !== null && _classPrivateFieldGet4 !== void 0 && _classPrivateFieldGet4.delete(key));\n    }\n  }, {\n    key: \"get\",\n    value: function get(key) {\n      var _classPrivateFieldGet5;\n      return (_classPrivateFieldGet5 = _classPrivateFieldGet(this, _cache)) === null || _classPrivateFieldGet5 === void 0 ? void 0 : _classPrivateFieldGet5.get(key);\n    }\n  }, {\n    key: \"has\",\n    value: function has(key) {\n      var _classPrivateFieldGet6;\n      return !!((_classPrivateFieldGet6 = _classPrivateFieldGet(this, _cache)) !== null && _classPrivateFieldGet6 !== void 0 && _classPrivateFieldGet6.has(key));\n    }\n  }, {\n    key: \"set\",\n    value: function set(key, value) {\n      _classPrivateFieldSet(this, _cache, _classPrivateFieldGet(this, _cache) || new Map());\n      _classPrivateFieldGet(this, _cache).set(key, value);\n      return this;\n    }\n  }]);\n  return DIContext;\n}();","map":{"version":3,"sources":["../../../src/domain/DIContext.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { runInContext } from \"../utils/asyncHookContext.js\";\nimport { ContextLogger } from \"./ContextLogger.js\";\nimport { LocalsContainer } from \"./LocalsContainer.js\";\nexport class DIContext {\n    opts;\n    #container;\n    #cache;\n    #logger;\n    constructor(opts) {\n        this.opts = opts;\n    }\n    /**\n     * Logger attached to the context request.\n     */\n    get logger() {\n        this.#logger = this.#logger || new ContextLogger(this.opts);\n        return this.#logger;\n    }\n    /**\n     * Request id generated by @@contextMiddleware@@.\n     *\n     * ::: tip\n     * By default Ts.ED generate uuid like that `uuidv4().replace(/-/gi, \"\"))`.\n     * Dash are removed to simplify tracking logs in Kibana\n     * :::\n     *\n     * ::: tip\n     * Request id can by customized by changing the server configuration.\n     *\n     * ```typescript\n     * @Configuration({\n     *   logger: {\n     *     reqIdBuilder: createUniqId // give your own id generator function\n     *   }\n     * })\n     * class Server {\n     *\n     * }\n     * ```\n     * :::\n     *\n     */\n    get id() {\n        return this.opts.id;\n    }\n    get dateStart() {\n        return this.logger.dateStart;\n    }\n    get injector() {\n        return this.opts.injector;\n    }\n    get env() {\n        return this.injector.settings.get(\"env\");\n    }\n    /**\n     * The request container used by the Ts.ED DI. It contains all services annotated with `@Scope(ProviderScope.REQUEST)`\n     */\n    get container() {\n        return (this.#container = this.#container || new LocalsContainer());\n    }\n    async destroy() {\n        return Promise.all([this.#container?.destroy(), this.#logger?.flush()]);\n    }\n    async emit(eventName, ...args) {\n        return this.injector?.emit(eventName, ...args);\n    }\n    async runInContext(next) {\n        return runInContext(this, next);\n    }\n    cache(key, cb) {\n        if (!this.has(key)) {\n            this.set(key, cb());\n        }\n        return this.get(key);\n    }\n    async cacheAsync(key, cb) {\n        if (!this.has(key)) {\n            this.set(key, await cb());\n        }\n        return this.get(key);\n    }\n    delete(key) {\n        return !!this.#cache?.delete(key);\n    }\n    get(key) {\n        return this.#cache?.get(key);\n    }\n    has(key) {\n        return !!this.#cache?.has(key);\n    }\n    set(key, value) {\n        this.#cache = this.#cache || new Map();\n        this.#cache.set(key, value);\n        return this;\n    }\n}\n//# sourceMappingURL=DIContext.js.map"]},"metadata":{},"sourceType":"module"}